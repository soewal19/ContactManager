<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Test - Contact Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .connection-status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .status-connected { background-color: #d4edda; color: #155724; }
        .status-disconnected { background-color: #f8d7da; color: #721c24; }
        .status-connecting { background-color: #fff3cd; color: #856404; }
        .message-log {
            height: 300px;
            overflow-y: auto;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1>WebSocket Test - Contact Manager</h1>
        
        <div id="connectionStatus" class="connection-status status-disconnected">
            <strong>Статус:</strong> <span id="statusText">Отключено</span>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <h3>Управление соединением</h3>
                <div class="mb-3">
                    <button id="connectBtn" class="btn btn-success">Подключиться</button>
                    <button id="disconnectBtn" class="btn btn-danger" disabled>Отключиться</button>
                    <button id="pingBtn" class="btn btn-info" disabled>Отправить Ping</button>
                </div>
                
                <h3>Отправка сообщений</h3>
                <div class="mb-3">
                    <label for="messageType" class="form-label">Тип сообщения:</label>
                    <select id="messageType" class="form-select">
                        <option value="Info">Info</option>
                        <option value="Error">Error</option>
                        <option value="ContactCreated">ContactCreated</option>
                        <option value="ContactUpdated">ContactUpdated</option>
                        <option value="ContactDeleted">ContactDeleted</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="messageData" class="form-label">Данные (JSON):</label>
                    <textarea id="messageData" class="form-control" rows="3" placeholder='{"name": "Test Contact", "email": "test@example.com"}'></textarea>
                </div>
                <div class="mb-3">
                    <label for="messageText" class="form-label">Текст сообщения:</label>
                    <input type="text" id="messageText" class="form-control" placeholder="Тестовое сообщение">
                </div>
                <button id="sendBtn" class="btn btn-primary" disabled>Отправить</button>
            </div>
            
            <div class="col-md-6">
                <h3>Лог сообщений</h3>
                <div id="messageLog" class="message-log"></div>
                <button id="clearLogBtn" class="btn btn-secondary btn-sm mt-2">Очистить лог</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        class WebSocketTest {
            constructor() {
                this.socket = null;
                this.connectionId = null;
                this.pingInterval = null;
                this.lastPongTime = null;
                
                this.initializeElements();
                this.bindEvents();
            }
            
            initializeElements() {
                this.connectBtn = document.getElementById('connectBtn');
                this.disconnectBtn = document.getElementById('disconnectBtn');
                this.pingBtn = document.getElementById('pingBtn');
                this.sendBtn = document.getElementById('sendBtn');
                this.clearLogBtn = document.getElementById('clearLogBtn');
                this.messageLog = document.getElementById('messageLog');
                this.connectionStatus = document.getElementById('connectionStatus');
                this.statusText = document.getElementById('statusText');
                this.messageType = document.getElementById('messageType');
                this.messageData = document.getElementById('messageData');
                this.messageText = document.getElementById('messageText');
            }
            
            bindEvents() {
                this.connectBtn.addEventListener('click', () => this.connect());
                this.disconnectBtn.addEventListener('click', () => this.disconnect());
                this.pingBtn.addEventListener('click', () => this.sendPing());
                this.sendBtn.addEventListener('click', () => this.sendMessage());
                this.clearLogBtn.addEventListener('click', () => this.clearLog());
            }
            
            connect() {
                try {
                    this.log('Попытка подключения к WebSocket...');
                    this.updateStatus('connecting', 'Подключение...');
                    
                    this.socket = new WebSocket('ws://localhost:5021/ws');
                    
                    this.socket.onopen = (event) => {
                        this.log('WebSocket подключен!', 'success');
                        this.updateStatus('connected', 'Подключено');
                        this.connectBtn.disabled = true;
                        this.disconnectBtn.disabled = false;
                        this.pingBtn.disabled = false;
                        this.sendBtn.disabled = false;
                    };
                    
                    this.socket.onmessage = (event) => {
                        this.handleMessage(event.data);
                    };
                    
                    this.socket.onclose = (event) => {
                        this.log(`WebSocket отключен. Код: ${event.code}, Причина: ${event.reason}`, 'warning');
                        this.updateStatus('disconnected', 'Отключено');
                        this.connectBtn.disabled = false;
                        this.disconnectBtn.disabled = true;
                        this.pingBtn.disabled = true;
                        this.sendBtn.disabled = true;
                        this.connectionId = null;
                    };
                    
                    this.socket.onerror = (error) => {
                        this.log('Ошибка WebSocket: ' + error, 'error');
                        this.updateStatus('disconnected', 'Ошибка');
                    };
                } catch (error) {
                    this.log('Ошибка при создании WebSocket: ' + error, 'error');
                    this.updateStatus('disconnected', 'Ошибка');
                }
            }
            
            disconnect() {
                if (this.socket) {
                    this.socket.close();
                }
            }
            
            sendPing() {
                if (this.socket && this.socket.readyState === WebSocket.OPEN) {
                    const message = {
                        Type: 'Ping',
                        Data: null,
                        Message: 'manual ping',
                        Timestamp: new Date().toISOString()
                    };
                    
                    this.socket.send(JSON.stringify(message));
                    this.log('Ping отправлен', 'info');
                    this.lastPongTime = Date.now();
                }
            }
            
            sendMessage() {
                if (this.socket && this.socket.readyState === WebSocket.OPEN) {
                    let data = null;
                    try {
                        const dataText = this.messageData.value.trim();
                        if (dataText) {
                            data = JSON.parse(dataText);
                        }
                    } catch (error) {
                        this.log('Ошибка парсинга JSON: ' + error, 'error');
                        return;
                    }
                    
                    const message = {
                        Type: this.messageType.value,
                        Data: data,
                        Message: this.messageText.value,
                        Timestamp: new Date().toISOString()
                    };
                    
                    this.socket.send(JSON.stringify(message));
                    this.log(`Сообщение отправлено: ${message.Type}`, 'info');
                }
            }
            
            handleMessage(data) {
                try {
                    const message = JSON.parse(data);
                    this.log(`Получено сообщение: ${message.Type}`, 'info', message);
                    
                    if (message.connectionId) {
                        this.connectionId = message.connectionId;
                        this.log(`ID подключения: ${message.connectionId}`, 'info');
                    }
                    
                    if (message.Type === 'Pong') {
                        const delay = Date.now() - this.lastPongTime;
                        this.log(`Pong получен! Задержка: ${delay}мс`, 'success');
                    }
                } catch (error) {
                    this.log('Ошибка обработки сообщения: ' + error, 'error');
                }
            }
            
            updateStatus(status, text) {
                this.connectionStatus.className = `connection-status status-${status}`;
                this.statusText.textContent = text;
            }
            
            log(message, type = 'info', data = null) {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry log-${type}`;
                logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
                
                if (data) {
                    const dataDiv = document.createElement('div');
                    dataDiv.className = 'log-data';
                    dataDiv.style.fontSize = '10px';
                    dataDiv.style.marginLeft = '20px';
                    dataDiv.textContent = JSON.stringify(data, null, 2);
                    logEntry.appendChild(dataDiv);
                }
                
                this.messageLog.appendChild(logEntry);
                this.messageLog.scrollTop = this.messageLog.scrollHeight;
            }
            
            clearLog() {
                this.messageLog.innerHTML = '';
            }
        }
        
        // Initialize the test when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            new WebSocketTest();
        });
    </script>
</body>
</html>